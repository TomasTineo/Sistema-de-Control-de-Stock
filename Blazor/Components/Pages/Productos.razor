@page "/productos"
@rendermode InteractiveServer
@using Blazor.Interfaces
@using Blazor.Services
@using DTOs.Productos
@inject IProductoService ProductoService
@inject NavigationManager Navigation

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>📦 Gestión de Productos</h1>
        <div>
            <button class="btn btn-outline-primary" @onclick="GoToDashboard">
                 Volver al Dashboard
            </button>
            <button class="btn btn-success ms-2" @onclick="GoToCreateProducto">
                <i class="bi bi-plus-circle"></i> Nuevo Producto
            </button>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando productos...</p>
        </div>
    }

    <!-- Error State -->
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger" role="alert">
            @ErrorMessage
            <button class="btn btn-sm btn-outline-danger ms-3" @onclick="CargarProductos">
                Reintentar
            </button>
        </div>
    }

    <!-- Success State -->
    @if (!isLoading && string.IsNullOrEmpty(ErrorMessage) && productos.Count == 0)
    {
        <div class="alert alert-info" role="alert">
            No hay productos registrados. ¡Crea tu primer producto!
        </div>
    }

    <!-- Products Grid -->
    @if (!isLoading && productos.Count > 0)
    {

        <!-- Barra de búsqueda -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text"
                                   class="form-control"
                                   placeholder="Buscar productos por nombre..."
                                   @bind="searchTerm"
                                   @bind:event="oninput" />
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <span class="badge bg-primary">
                            @productosFiltrados.Count productos
                        </span>
                    </div>
                </div>
            </div>
        </div>



        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Descripción</th>
                        <th>Precio</th>
                        <th>Stock</th>
                        <th>Categoría ID</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var producto in productosFiltrados)
                    {
                        <tr>
                            <td>@producto.Id</td>
                            <td>
                                <strong>@producto.Nombre</strong>
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(producto.Descripcion))
                                {
                                    <span class="text-muted">@producto.Descripcion</span>
                                }
                                else
                                {
                                    <span class="text-muted fst-italic">Sin descripción</span>
                                }
                            </td>
                            <td>
                                <span class="badge bg-success fs-6">
                                    $@producto.Precio.ToString("N2")
                                </span>
                            </td>
                            <td>
                                @if (producto.Stock > 10)
                                {
                                    <span class="badge bg-success">@producto.Stock unidades</span>
                                }
                                else if (producto.Stock > 0)
                                {
                                    <span class="badge bg-warning">@producto.Stock unidades</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Agotado</span>
                                }
                            </td>
                            <td>
                                <span class="badge bg-info">Categoría @producto.CategoriaId</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    
                                    <button class="btn btn-sm btn-outline-warning" 
                                            @onclick="() => EditarProducto(producto.Id)"
                                            title="Editar">
                                        <i class="bi bi-pencil"></i>
                                        Editar
                                    </button>
                                   
                                    <button class="btn btn-sm btn-outline-danger"
                                            @onclick="() => EliminarProducto(producto)"
                                            title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                        Eliminar
                                    </button>
                                    
                                    
                                    
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Summary -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title">Resumen</h5>
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-box-seam fs-4 text-primary me-3"></i>
                            <div>
                                <h6 class="mb-0">Total Productos</h6>
                                <p class="fs-4 mb-0">@productos.Count</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-cash-coin fs-4 text-success me-3"></i>
                            <div>
                                <h6 class="mb-0">Valor Total</h6>
                                <p class="fs-4 mb-0">$@(productos.Sum(p => p.Precio * p.Stock).ToString("N2"))</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-archive fs-4 text-info me-3"></i>
                            <div>
                                <h6 class="mb-0">Stock Total</h6>
                                <p class="fs-4 mb-0">@productos.Sum(p => p.Stock) unidades</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-tags fs-4 text-warning me-3"></i>
                            <div>
                                <h6 class="mb-0">Categorías</h6>
                                <p class="fs-4 mb-0">@productos.Select(p => p.CategoriaId).Distinct().Count()</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private List<ProductoDTO> productos = new();
    private bool isLoading = true;
    private string ErrorMessage = string.Empty;
	private string searchTerm = string.Empty;

    private List<ProductoDTO> productosFiltrados => GetFilteredProducts();

    // Métodos de filtrado
    private List<ProductoDTO> GetFilteredProducts()
    {
        if (string.IsNullOrWhiteSpace(searchTerm))
            return productos;

        var term = searchTerm.ToLower();
        return productos.Where(c =>
        c.Nombre.ToLower().Contains(term) ||
        (c.Descripcion != null && c.Descripcion.ToLower().Contains(term))
        ).ToList();
    }

    protected override async Task OnInitializedAsync()
    {
        await CargarProductos();
    }

    private async Task CargarProductos()
    {
        isLoading = true;
        ErrorMessage = string.Empty;
        
        try
        {
            productos = await ProductoService.GetProductosAsync();
            Console.WriteLine($"Se cargaron {productos.Count} productos");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error al cargar productos: {ex.Message}";
            Console.WriteLine($"Error: {ex.Message}");
            productos = new List<ProductoDTO>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void GoToDashboard()
    {
        Navigation.NavigateTo("/dashboard");
    }

    private void GoToCreateProducto()
    {
        Navigation.NavigateTo("/productos/nuevo");
    }

    private void VerDetalles(int id)
    {
        Navigation.NavigateTo($"/productos/{id}");
    }

    private void EditarProducto(int id)
    {
        Navigation.NavigateTo($"/productos/editar/{id}");
    }

    private async Task EliminarProducto(ProductoDTO producto)
    {
        // Puedes agregar confirmación aquí
        var confirmar = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"¿Estás seguro de eliminar el producto '{producto.Nombre}'?");
        
        if (confirmar)
        {
            try
            {
                var resultado = await ProductoService.DeleteProductoAsync(producto.Id);
                
                if (resultado)
                {
                    await CargarProductos(); // Recargar la lista
                }
                else
                {
                    ErrorMessage = "No se pudo eliminar el producto. Puede que tenga reservas asociadas.";
                    StateHasChanged();
                }
            }
            catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                ErrorMessage = "❌ No se puede eliminar el producto porque tiene reservas asociadas. Elimina o completa las reservas primero.";
                Console.WriteLine($"Producto con reservas asociadas: {ex.Message}");
                StateHasChanged();
            }
            catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Forbidden)
            {
                ErrorMessage = "❌ Acceso denegado: Se requiere ser administrador para ejecutar la acción.";
                StateHasChanged();
            }
            catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                ErrorMessage = "No autorizado: Tu sesión ha expirado.";
                StateHasChanged();
                await Task.Delay(2000);
                Navigation.NavigateTo("/");
            }
            catch (Exception ex)
            {
                ErrorMessage = $"❌ Error al eliminar producto: {ex.Message}";
                Console.WriteLine($"Error eliminando producto: {ex.Message}");
                StateHasChanged();
            }
        }
    }

    [Inject] 
    private IJSRuntime JSRuntime { get; set; } = default!;
}