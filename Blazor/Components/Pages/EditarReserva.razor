@page "/reservas/editar/{id:int}"
@rendermode InteractiveServer
@using DTOs.Reservas
@using DTOs.Clientes
@using DTOs.Eventos
@using DTOs.Productos
@using Blazor.Services
@inject IReservaService ReservaService
@inject IClienteService ClienteService
@inject IEventoService EventoService
@inject IProductoService ProductoService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="bi bi-calendar-check"></i> Editar Reserva</h1>
            <p class="text-muted">Modifica los detalles de la reserva</p>
        </div>
        <div>
            <button class="btn btn-outline-secondary" @onclick="VolverALista">
                <i class="bi bi-arrow-left"></i> Volver a Reservas
            </button>
        </div>
    </div>

    <!-- Estado inicial -->
    @if (!_hasInitialized)
    {
        <div class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Inicializando...</span>
            </div>
            <p class="mt-2">Inicializando editor...</p>
        </div>
    }
    else
    {
        <!-- Loading State -->
        @if (isLoading)
        {
            <div class="text-center my-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">Cargando reserva...</p>
            </div>
        }

        <!-- Error State -->
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger" role="alert">
                <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
                <p>@ErrorMessage</p>
                @if (ShowRetryButton)
                {
                    <button class="btn btn-outline-danger mt-2" @onclick="CargarDatos">
                        Reintentar
                    </button>
                }
            </div>
        }

        <!-- Reserva no encontrada -->
        @if (!isLoading && string.IsNullOrEmpty(ErrorMessage) && reserva == null)
        {
            <div class="alert alert-warning">
                <h5><i class="bi bi-exclamation-triangle"></i> Reserva no encontrada</h5>
                <p>La reserva con ID @Id no existe o no se pudo cargar.</p>
                <button class="btn btn-outline-primary" @onclick="VolverALista">
                    Volver a la lista
                </button>
            </div>
        }

        <!-- Formulario de edición -->
        @if (!isLoading && string.IsNullOrEmpty(ErrorMessage) && reserva != null)
        {
            <div class="row">
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-pencil-square"></i> Editando Reserva #@reserva.Id
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Información de la reserva -->
                            <div class="alert alert-info mb-4">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-info-circle fs-4 me-3"></i>
                                    <div>
                                        <strong>Reserva creada:</strong> @reserva.FechaReserva.ToString("dd/MM/yyyy HH:mm")
                                        <br />
                                        <strong>Cliente:</strong> @reserva.Cliente?.Nombre @reserva.Cliente?.Apellido
                                        <br />
                                        <strong>Evento:</strong> @reserva.Evento?.NombreEvento - @reserva.Evento?.FechaEvento.ToString("dd/MM/yyyy")
                                    </div>
                                </div>
                            </div>

                            <!-- Success Message -->
                            @if (!string.IsNullOrEmpty(SuccessMessage))
                            {
                                <div class="alert alert-success alert-dismissible fade show" role="alert">
                                    <i class="bi bi-check-circle-fill"></i> @SuccessMessage
                                    <button type="button" class="btn-close" @onclick="CerrarMensajes"></button>
                                </div>
                            }

                            <!-- Form -->
                            <EditForm Model="@updateRequest" OnValidSubmit="@ActualizarReserva">
                                <DataAnnotationsValidator />
                                <ValidationSummary class="alert alert-danger" />

                                <div class="row g-3">
                                    <!-- Cliente (solo lectura si ya está asignado) -->
                                    <div class="col-md-6">
                                        <label for="clienteId" class="form-label fw-bold">
                                            <i class="bi bi-person me-1"></i> Cliente
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="bi bi-people"></i>
                                            </span>
                                            <input type="text"
                                                   class="form-control"
                                                   value="@reserva.Cliente?.Nombre @reserva.Cliente?.Apellido"
                                                   readonly />
                                        </div>
                                        <div class="form-text">El cliente no se puede cambiar después de creada la reserva</div>
                                    </div>

                                    <!-- Evento (solo lectura si ya está asignado) -->
                                    <div class="col-md-6">
                                        <label for="eventoId" class="form-label fw-bold">
                                            <i class="bi bi-calendar-event me-1"></i> Evento
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="bi bi-calendar-check"></i>
                                            </span>
                                            <input type="text"
                                                   class="form-control"
                                                   value="@reserva.Evento?.NombreEvento - @reserva.Evento?.FechaEvento.ToString("dd/MM/yyyy")"
                                                   readonly />
                                        </div>
                                        <div class="form-text">El evento no se puede cambiar después de creada la reserva</div>
                                    </div>

                                    <!-- Fecha Finalización -->
                                    <div class="col-md-6">
                                        <label for="fechaFinalizacion" class="form-label fw-bold">
                                            <i class="bi bi-calendar-x me-1"></i> Fecha de Finalización *
                                        </label>
                                        <input type="date"
                                               id="fechaFinalizacion"
                                               class="form-control @(validationErrors.ContainsKey("FechaFinalizacion") ? "is-invalid" : "")"
                                               @bind="updateRequest.FechaFinalizacion"
                                               @bind:format="yyyy-MM-dd"
                                               min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                                        @if (validationErrors.ContainsKey("FechaFinalizacion"))
                                        {
                                            <div class="invalid-feedback d-block">
                                                @validationErrors["FechaFinalizacion"]
                                            </div>
                                        }
                                        <div class="form-text">Fecha límite para la reserva</div>
                                    </div>

                                    <!-- Estado -->
                                    <div class="col-md-6">
                                        <label for="estado" class="form-label fw-bold">
                                            <i class="bi bi-tag me-1"></i> Estado *
                                        </label>
                                        <select id="estado"
                                                class="form-select @(validationErrors.ContainsKey("Estado") ? "is-invalid" : "")"
                                                @bind="updateRequest.Estado">
                                            <option value="Pendiente">Pendiente</option>
                                            <option value="Confirmada">Confirmada</option>
                                            <option value="Cancelada">Cancelada</option>
                                            <option value="Finalizada">Finalizada</option>
                                        </select>
                                        @if (validationErrors.ContainsKey("Estado"))
                                        {
                                            <div class="invalid-feedback d-block">
                                                @validationErrors["Estado"]
                                            </div>
                                        }
                                        <div class="form-text">Estado actual de la reserva</div>
                                    </div>

                                    <!-- Productos de la Reserva -->
                                    <div class="col-12">
                                        <div class="card border-primary mt-3">
                                            <div class="card-header bg-primary text-white">
                                                <h6 class="mb-0">
                                                    <i class="bi bi-box-seam"></i> Productos de la Reserva
                                                    <span class="badge bg-light text-primary ms-2">
                                                        @updateRequest.Productos.Sum(p => p.CantidadReservada) unidades
                                                    </span>
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                @if (productos.Count == 0)
                                                {
                                                    <div class="alert alert-warning">
                                                        <i class="bi bi-exclamation-triangle"></i>
                                                        No hay productos disponibles.
                                                    </div>
                                                }
                                                else if (updateRequest.Productos.Count == 0)
                                                {
                                                    <div class="alert alert-info">
                                                        <i class="bi bi-info-circle"></i>
                                                        Esta reserva no tiene productos asignados.
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="table-responsive">
                                                        <table class="table table-sm table-hover">
                                                            <thead class="table-light">
                                                                <tr>
                                                                    <th>Producto</th>
                                                                    <th class="text-center">Cantidad Actual</th>
                                                                    <th class="text-center">Stock Disponible</th>
                                                                    <th class="text-center">Nueva Cantidad</th>
                                                                    <th class="text-end">Precio Unit.</th>
                                                                    <th class="text-end">Subtotal</th>
                                                                    <th class="text-end">Acciones</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                @foreach (var item in updateRequest.Productos)
                                                                {
                                                                    var productoInfo = productos.FirstOrDefault(p => p.Id == item.ProductoId);
                                                                    var cantidadOriginal = reserva.Productos?.FirstOrDefault(p => p.ProductoId == item.ProductoId)?.CantidadReservada ?? 0;
                                                                    var stockDisponible = productoInfo?.Stock ?? 0;
                                                                    // Stock ajustado considerando lo ya reservado en esta reserva
                                                                    var stockAjustado = stockDisponible + cantidadOriginal;

                                                                    <tr>
                                                                        <td>
                                                                            <strong>@(productoInfo?.Nombre ?? "Producto no encontrado")</strong>
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <span class="badge bg-secondary">@cantidadOriginal</span>
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <span class="badge @(stockDisponible > 0 ? "bg-success" : "bg-danger")">
                                                                                @stockDisponible
                                                                            </span>
                                                                        </td>
                                                                        <td class="text-center">
                                                                            <div class="input-group" style="max-width: 180px;">
                                                                                
                                                                                <input type="number"
                                                                                       class="form-control text-center"
                                                                                       style="width: 70px; font-size: 1rem; padding: 0.25rem;"
                                                                                       @bind="item.CantidadReservada"
                                                                                       @bind:event="oninput"
                                                                                       min="0"
                                                                                       max="@stockAjustado" />
                                                                                
                                                                            </div>
                                                                        </td>
                                                                        <td class="text-end">
                                                                            $@(productoInfo?.Precio ?? 0)
                                                                        </td>
                                                                        <td class="text-end">
                                                                            <strong>$@((productoInfo?.Precio ?? 0) * item.CantidadReservada)</strong>
                                                                        </td>
                                                                        <td class="text-end">
                                                                            <button type="button"
                                                                                    class="btn btn-sm btn-outline-danger"
                                                                                    @onclick="() => RemoverProducto(item.ProductoId)">
                                                                                    Remover
                                                                                <i class="bi bi-trash"></i>
                                                                            </button>
                                                                        </td>
                                                                    </tr>
                                                                }
                                                            </tbody>
                                                            <tfoot class="table-secondary">
                                                                <tr>
                                                                    <td colspan="5" class="text-end fw-bold">Total estimado:</td>
                                                                    <td class="text-end fw-bold">
                                                                        $@CalcularTotalEstimado().ToString("N2")
                                                                    </td>
                                                                    <td></td>
                                                                </tr>
                                                            </tfoot>
                                                        </table>
                                                    </div>

                                                    <!-- Agregar nuevo producto -->
                                                    <div class="card border-success mt-4">
                                                        <div class="card-header bg-success text-white">
                                                            <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Agregar Nuevo Producto</h6>
                                                        </div>
                                                        <div class="card-body">
                                                            <div class="row g-3">
                                                                <div class="col-md-6">
                                                                    <label class="form-label">Seleccionar Producto</label>
                                                                    <select class="form-select" @bind="nuevoProductoId" @bind:event="onchange">
                                                                        <option value="0">Seleccionar producto...</option>
                                                                        @foreach (var producto in productosDisponiblesParaAgregar)
                                                                        {
                                                                            <option value="@producto.Id">
                                                                                @producto.Nombre - Stock: @producto.Stock - $@producto.Precio.ToString("N2")
                                                                            </option>
                                                                        }
                                                                    </select>
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <label class="form-label">Cantidad</label>
                                                                    <div class="input-group">
                                                                        <button class="btn btn-outline-secondary" type="button"
                                                                                @onclick="DecrementarNuevaCantidad"
                                                                                disabled="@(nuevaCantidad <= 1 || nuevoProductoId == 0)">
                                                                                -
                                                                            <i class="bi bi-dash"></i>
                                                                        </button>
                                                                        <input type="number"
                                                                               class="form-control text-center"
                                                                               @bind="nuevaCantidad"
                                                                               min="1"
                                                                               max="@(nuevoProductoId > 0 ? ObtenerStockDisponibleParaNuevo(nuevoProductoId) : 1)"
                                                                               disabled="@(nuevoProductoId == 0)" />
                                                                        <button class="btn btn-outline-secondary" type="button"
                                                                                @onclick="IncrementarNuevaCantidad"
                                                                                disabled="@(nuevoProductoId == 0 || nuevaCantidad >= ObtenerStockDisponibleParaNuevo(nuevoProductoId))">
                                                                                +
                                                                            <i class="bi bi-plus"></i>
                                                                        </button>
                                                                    </div>
                                                                    <small class="text-muted">
                                                                        Stock disponible: @(nuevoProductoId > 0 ? ObtenerStockDisponibleParaNuevo(nuevoProductoId) : 0)
                                                                    </small>
                                                                </div>
                                                                <div class="col-md-2 d-flex align-items-end">
                                                                    <button class="btn btn-success w-100"
                                                                            type="button"
                                                                            @onclick="AgregarNuevoProducto"
                                                                            disabled="@(nuevoProductoId == 0 || nuevaCantidad <= 0)">
                                                                        <i class="bi bi-plus"></i> Agregar
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Botones -->
                                    <div class="col-12 mt-4">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <button type="button" class="btn btn-outline-danger me-2" @onclick="EliminarReserva">
                                                    <i class="bi bi-trash"></i> Eliminar Reserva
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary" @onclick="VolverALista">
                                                    <i class="bi bi-x-circle"></i> Cancelar
                                                </button>
                                            </div>
                                            <div>
                                                <button type="button" class="btn btn-outline-info me-2" @onclick="RestaurarOriginal">
                                                    <i class="bi bi-arrow-counterclockwise"></i> Restaurar
                                                </button>
                                                <button type="submit" class="btn btn-warning" disabled="@isSaving">
                                                    @if (isSaving)
                                                    {
                                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                                        <span> Actualizando...</span>
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-check-circle"></i>
                                                        <span> Actualizar Reserva</span>
                                                    }
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </EditForm>
                        </div>
                    </div>
                </div>

                <!-- Panel lateral - Resumen -->
                <div class="col-lg-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-info-circle"></i> Resumen
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Información de la reserva -->
                            <div class="mb-3">
                                <h6><i class="bi bi-calendar-check text-primary"></i> Reserva #@reserva.Id</h6>
                                <p class="mb-1">
                                    <strong>Creada:</strong> @reserva.FechaReserva.ToString("dd/MM/yyyy HH:mm")
                                </p>
                                <p class="mb-1">
                                    <strong>Total original:</strong> $@reserva.TotalReserva.ToString("N2")
                                </p>
                                <p class="mb-1">
                                    <strong>Productos originales:</strong> @reserva.CantidadTiposProductos tipos
                                </p>
                            </div>

                            <!-- Cambios -->
                            <div class="mb-3">
                                <h6><i class="bi bi-arrow-left-right text-warning"></i> Cambios</h6>
                                <p class="mb-1">
                                    <strong>Estado:</strong>
                                    <span class="badge @GetEstadoBadgeClass(reserva.Estado)">@reserva.Estado</span>
                                    <i class="bi bi-arrow-right mx-1"></i>
                                    <span class="badge @GetEstadoBadgeClass(updateRequest.Estado)">@updateRequest.Estado</span>
                                </p>
                                <p class="mb-1">
                                    <strong>Finalización:</strong>
                                    <br />
                                    <small>@reserva.FechaFinalizacion.ToString("dd/MM/yyyy")</small>
                                    <i class="bi bi-arrow-right mx-1"></i>
                                    <small>@updateRequest.FechaFinalizacion.ToString("dd/MM/yyyy")</small>
                                </p>
                                <p class="mb-1">
                                    <strong>Productos:</strong>
                                    <br />
                                    <small>Original: @reserva.Productos?.Count ?? 0</small>
                                    <i class="bi bi-arrow-right mx-1"></i>
                                    <small>Nuevo: @updateRequest.Productos.Count</small>
                                </p>
                            </div>

                            <!-- Total estimado nuevo -->
                            <div class="mt-4 pt-3 border-top">
                                <h5 class="text-end text-success">
                                    Nuevo total: $@CalcularTotalEstimado().ToString("N2")
                                </h5>
                                <small class="text-muted d-block text-end">
                                    @updateRequest.Productos.Count productos
                                </small>
                            </div>
                        </div>
                    </div>

                    
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter] public int Id { get; set; }

    // Modelos
    private ReservaDTO? reserva;
    private UpdateReservaRequest updateRequest = new();
    private UpdateReservaRequest? originalRequest;

    // Datos para los selects
    private List<ProductoDTO> productos = new();

    // Para agregar nuevo producto
    private int nuevoProductoId = 0;
    private int nuevaCantidad = 1;

    // Estados
    private bool _hasInitialized = false;
    private bool isLoading = true;
    private bool isSaving = false;
    private bool ShowRetryButton = false;
    private string ErrorMessage = string.Empty;
    private string SuccessMessage = string.Empty;
    private Dictionary<string, string> validationErrors = new();

    // Propiedades calculadas
    private List<ProductoDTO> productosDisponibles => productos.Where(p => p.Stock > 0).ToList();

    private List<ProductoDTO> productosDisponiblesParaAgregar =>
        productos.Where(p => p.Stock > 0 && !updateRequest.Productos.Any(rp => rp.ProductoId == p.Id)).ToList();

    // Inicialización
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_hasInitialized)
        {
            await InicializarPagina();
        }
    }

    private async Task InicializarPagina()
    {
        try
        {
            Console.WriteLine($"=== INICIALIZANDO PÁGINA EDITAR RESERVA (ID: {Id}) ===");
            _hasInitialized = true;
            StateHasChanged();

            await CargarDatos();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando: {ex.Message}");
            ErrorMessage = "Error al inicializar la página.";
            _hasInitialized = true;
            isLoading = false;
            ShowRetryButton = true;
            StateHasChanged();
        }
    }

    private async Task CargarDatos()
    {
        isLoading = true;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        validationErrors.Clear();
        StateHasChanged();

        try
        {
            Console.WriteLine($"Cargando reserva con ID: {Id}");

            // Cargar reserva
            reserva = await ReservaService.GetReservaByIdAsync(Id);

            if (reserva == null)
            {
                ErrorMessage = $"Reserva con ID {Id} no encontrada.";
                return;
            }

            Console.WriteLine($"Reserva cargada: ID {reserva.Id}, Cliente: {reserva.Cliente?.Nombre}");

            // Cargar productos
            productos = await ProductoService.GetProductosAsync();
            Console.WriteLine($"Productos cargados: {productos.Count}");

            // Preparar updateRequest
            updateRequest = new UpdateReservaRequest
            {
                Id = reserva.Id,
                ClienteId = reserva.ClienteId,
                EventoId = reserva.EventoId,
                FechaFinalizacion = reserva.FechaFinalizacion,
                Estado = reserva.Estado,
                Productos = reserva.Productos?.Select(p => new UpdateReservaProductoRequest
                {
                    ProductoId = p.ProductoId,
                    CantidadReservada = p.CantidadReservada
                }).ToList() ?? new List<UpdateReservaProductoRequest>()
            };

            // Guardar copia original para restaurar
            originalRequest = new UpdateReservaRequest
            {
                Id = updateRequest.Id,
                ClienteId = updateRequest.ClienteId,
                EventoId = updateRequest.EventoId,
                FechaFinalizacion = updateRequest.FechaFinalizacion,
                Estado = updateRequest.Estado,
                Productos = updateRequest.Productos.Select(p => new UpdateReservaProductoRequest
                {
                    ProductoId = p.ProductoId,
                    CantidadReservada = p.CantidadReservada
                }).ToList()
            };

            Console.WriteLine($"UpdateRequest preparado: {updateRequest.Productos.Count} productos");
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            ErrorMessage = "Reserva no encontrada.";
            ShowRetryButton = false;
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            ErrorMessage = "No tienes permisos para editar reservas.";
            await Task.Delay(2000);
            Navigation.NavigateTo("/", true);
        }
        catch (HttpRequestException ex)
        {
            ErrorMessage = $"Error {ex.StatusCode}: {ex.Message}";
            ShowRetryButton = true;
            Console.WriteLine($"Error HTTP: {ex.Message}");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error: {ex.Message}";
            ShowRetryButton = true;
            Console.WriteLine($"Error general: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Métodos para productos
    private void IncrementarCantidadProducto(UpdateReservaProductoRequest producto, int maxStock)
    {
        if (producto.CantidadReservada < maxStock)
        {
            producto.CantidadReservada++;
            StateHasChanged();
        }
    }

    private void DecrementarCantidadProducto(UpdateReservaProductoRequest producto)
    {
        if (producto.CantidadReservada > 0)
        {
            producto.CantidadReservada--;
            StateHasChanged();
        }
    }

    private void IncrementarNuevaCantidad()
    {
        if (nuevoProductoId > 0 && nuevaCantidad < ObtenerStockDisponibleParaNuevo(nuevoProductoId))
        {
            nuevaCantidad++;
        }
    }

    private void DecrementarNuevaCantidad()
    {
        if (nuevaCantidad > 1)
        {
            nuevaCantidad--;
        }
    }

    private int ObtenerStockDisponibleParaNuevo(int productoId)
    {
        if (productoId == 0) return 0;

        var producto = productos.FirstOrDefault(p => p.Id == productoId);
        if (producto == null) return 0;

        return producto.Stock;
    }

    private async Task AgregarNuevoProducto()
    {
        if (nuevoProductoId == 0 || nuevaCantidad <= 0)
            return;

        var producto = productos.FirstOrDefault(p => p.Id == nuevoProductoId);
        if (producto == null) return;

        var stockDisponible = ObtenerStockDisponibleParaNuevo(nuevoProductoId);
        if (nuevaCantidad > stockDisponible)
        {
            await JSRuntime.InvokeVoidAsync("alert",
                $"Stock insuficiente. Solo hay {stockDisponible} unidades disponibles.");
            return;
        }

        updateRequest.Productos.Add(new UpdateReservaProductoRequest
        {
            ProductoId = nuevoProductoId,
            CantidadReservada = nuevaCantidad
        });

        // Resetear selección
        nuevoProductoId = 0;
        nuevaCantidad = 1;

        StateHasChanged();
    }

    private void RemoverProducto(int productoId)
    {
        var producto = updateRequest.Productos.FirstOrDefault(p => p.ProductoId == productoId);
        if (producto != null)
        {
            updateRequest.Productos.Remove(producto);
            StateHasChanged();
        }
    }

    private decimal CalcularTotalEstimado()
    {
        decimal total = 0;
        foreach (var item in updateRequest.Productos)
        {
            var producto = productos.FirstOrDefault(p => p.Id == item.ProductoId);
            if (producto != null)
            {
                total += producto.Precio * item.CantidadReservada;
            }
        }
        return total;
    }

    // Método para actualizar la reserva
    private async Task ActualizarReserva()
    {
        if (!ValidarReserva())
            return;

        isSaving = true;
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        validationErrors.Clear();
        StateHasChanged();

        try
        {
            Console.WriteLine($"=== ACTUALIZANDO RESERVA #{Id} ===");
            Console.WriteLine($"Estado: {updateRequest.Estado}");
            Console.WriteLine($"FechaFinalizacion: {updateRequest.FechaFinalizacion}");
            Console.WriteLine($"Productos: {updateRequest.Productos.Count}"); 

            var reservaActualizada = await ReservaService.UpdateReservaAsync(updateRequest);

            if (reservaActualizada != null)
            {
                SuccessMessage = $"¡Reserva #{Id} actualizada exitosamente!";
                Console.WriteLine($"Reserva actualizada");

                // Actualizar datos locales
                reserva = reservaActualizada;

                // Actualizar originalRequest para restaurar
                originalRequest = new UpdateReservaRequest
                {
                    Id = updateRequest.Id,
                    ClienteId = updateRequest.ClienteId,
                    EventoId = updateRequest.EventoId,
                    FechaFinalizacion = updateRequest.FechaFinalizacion,
                    Estado = updateRequest.Estado,
                    Productos = updateRequest.Productos.Select(p => new UpdateReservaProductoRequest
                    {
                        ProductoId = p.ProductoId,
                        CantidadReservada = p.CantidadReservada
                    }).ToList()
                };
            }
            else
            {
                ErrorMessage = "No se pudo actualizar la reserva. Intenta nuevamente.";
            }
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            ErrorMessage = "Reserva no encontrada. Puede haber sido eliminada.";
            await Task.Delay(2000);
            VolverALista();
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.Unauthorized)
        {
            ErrorMessage = "No tienes permisos para actualizar reservas.";
            await Task.Delay(2000);
            Navigation.NavigateTo("/", true);
        }
        catch (HttpRequestException ex) when (ex.StatusCode == System.Net.HttpStatusCode.BadRequest)
        {
            ErrorMessage = "Datos inválidos. Verifica la información ingresada.";
        }
        catch (HttpRequestException ex)
        {
            ErrorMessage = $"Error {ex.StatusCode}: {ex.Message}";
            Console.WriteLine($"Error HTTP: {ex.Message}");
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error inesperado: {ex.Message}";
            Console.WriteLine($"Error general: {ex.Message}");
        }
        finally
        {
            isSaving = false;
            StateHasChanged();
        }
    }

    private bool ValidarReserva()
    {
        validationErrors.Clear();
        bool isValid = true;

        // Validar Fecha Finalización
        if (updateRequest.FechaFinalizacion < DateTime.Today)
        {
            validationErrors["FechaFinalizacion"] = "La fecha de finalización no puede ser pasada.";
            isValid = false;
        }

        // Validar Estado
        if (string.IsNullOrWhiteSpace(updateRequest.Estado))
        {
            validationErrors["Estado"] = "El estado es obligatorio.";
            isValid = false;
        }

        // Validar Productos
        if (updateRequest.Productos.Count == 0)
        {
            ErrorMessage = "La reserva debe tener al menos un producto.";
            isValid = false;
        }

        // Validar stock de productos
        foreach (var producto in updateRequest.Productos)
        {
            var productoInfo = productos.FirstOrDefault(p => p.Id == producto.ProductoId);
            if (productoInfo == null)
            {
                ErrorMessage = "Uno de los productos seleccionados no existe.";
                isValid = false;
                break;
            }

            // Verificar si este producto ya estaba en la reserva original
            var cantidadOriginal = reserva?.Productos?.FirstOrDefault(p => p.ProductoId == producto.ProductoId)?.CantidadReservada ?? 0;
            var stockNecesarioAdicional = producto.CantidadReservada - cantidadOriginal;

            if (stockNecesarioAdicional > 0 && productoInfo.Stock < stockNecesarioAdicional)
            {
                ErrorMessage = $"El producto '{productoInfo.Nombre}' no tiene suficiente stock adicional. Stock disponible: {productoInfo.Stock}";
                isValid = false;
                break;
            }
        }

        return isValid;
    }

    private async Task RestaurarOriginal()
    {
        if (originalRequest == null) return;

        var confirmar = await JSRuntime.InvokeAsync<bool>("confirm",
            "¿Estás seguro de restaurar los valores originales? Se perderán todos los cambios.");

        if (confirmar)
        {
            updateRequest.FechaFinalizacion = originalRequest.FechaFinalizacion;
            updateRequest.Estado = originalRequest.Estado;
            updateRequest.Productos = originalRequest.Productos.Select(p => new UpdateReservaProductoRequest
            {
                ProductoId = p.ProductoId,
                CantidadReservada = p.CantidadReservada
            }).ToList();

            validationErrors.Clear();
            ErrorMessage = string.Empty;
            SuccessMessage = "Valores originales restaurados.";
            StateHasChanged();
        }
    }

    private async Task EliminarReserva()
    {
        if (reserva == null) return;

        var confirmar = await JSRuntime.InvokeAsync<bool>("confirm",
            $"¿Estás seguro de eliminar la reserva #{reserva.Id}? Esta acción no se puede deshacer.");

        if (confirmar)
        {
            try
            {
                var resultado = await ReservaService.DeleteReservaAsync(reserva.Id);
                if (resultado)
                {
                    await JSRuntime.InvokeVoidAsync("alert", $"Reserva #{reserva.Id} eliminada exitosamente.");
                    VolverALista();
                }
                else
                {
                    ErrorMessage = "No se pudo eliminar la reserva.";
                    StateHasChanged();
                }
            }
            catch (Exception ex)
            {
                ErrorMessage = $"Error al eliminar reserva: {ex.Message}";
                StateHasChanged();
            }
        }
    }

    private async Task ConfirmarReserva()
    {
        updateRequest.Estado = "Confirmada";
        await ActualizarReserva();
    }

    private async Task CancelarReserva()
    {
        updateRequest.Estado = "Cancelada";
        await ActualizarReserva();
    }

    private void VolverALista()
    {
        Navigation.NavigateTo("/reservas");
    }

    private void VerDetalles()
    {
        Navigation.NavigateTo($"/reservas/{Id}");
    }

    private void CerrarMensajes()
    {
        ErrorMessage = string.Empty;
        SuccessMessage = string.Empty;
        StateHasChanged();
    }

    private string GetEstadoBadgeClass(string estado)
    {
        return estado switch
        {
            "Pendiente" => "bg-warning",
            "Confirmada" => "bg-success",
            "Cancelada" => "bg-danger",
            "Finalizada" => "bg-info",
            _ => "bg-secondary"
        };
    }
}

<style>
    .form-select.is-invalid,
    .form-control.is-invalid {
        border-color: #dc3545;
    }

    .invalid-feedback {
        display: block;
        width: 100%;
        margin-top: 0.25rem;
        font-size: 0.875em;
        color: #dc3545;
    }

    .card {
        border: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .input-group-text {
        background-color: #f8f9fa;
    }

    .badge {
        font-size: 0.85em;
        padding: 0.4em 0.8em;
    }

    .table-sm th,
    .table-sm td {
        padding: 0.5rem;
    }

    .input-group-sm {
        width: auto;
    }

    .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #212529;
    }

        .btn-warning:hover {
            background-color: #e0a800;
            border-color: #d39e00;
            color: #212529;
        }

    /* Responsive */
    @@media (max-width: 768px) {
        .d-flex.justify-content-between {
            flex-direction: column;
            gap: 1rem;
        }

            .d-flex.justify-content-between > div {
                width: 100%;
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .d-flex.justify-content-between .btn {
                width: 100%;
                margin-bottom: 0.5rem;
            }

        .table-responsive {
            font-size: 0.8rem;
        }
    }
</style>