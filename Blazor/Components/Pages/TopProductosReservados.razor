@page "/reportes/top-productos-reservados"
@rendermode InteractiveServer
@using Blazor.Interfaces
@using DTOs.Reportes
@using Syncfusion.Blazor.Charts
@inject IReportesService ReportesService
@inject NavigationManager Navigation

<div class="d-flex justify-content-start align-items-center mb-3 gap-5">
    
    <div>
        <h3 class="mb-0">Top Productos Más Reservados</h3>
    </div>
    <div>
        <button class="btn btn-secondary" @onclick="Volver">
            Volver
        </button>
    </div>
</div>


<div class="mb-3">
    <label class="form-label">Cantidad a mostrar:</label>
    <div class="input-group" style="width: 200px;">
        <input type="number"
               @bind="cant"
               @bind:event="oninput"
               min="1"
               max="50"
               class="form-control"
               @onkeypress="HandleKeyPress" />
        <button class="btn btn-primary" @onclick="HandleOnClick" disabled="@cargando">
            @if (cargando)
            {
                <span class="spinner-border spinner-border-sm"></span>
            }
            else
            {
                <span>Aplicar</span>
            }
        </button>

     
    </div>
    <small class="text-muted">Mostrando: @(topProductos?.Count ?? 0) de @cant solicitados</small>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">
        <strong>Error:</strong> @errorMessage
    </div>
}

@if (cargando)
{
    <div class="text-center">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p>Cargando gráfico...</p>
    </div>
}
else if (topProductos == null)
{
    <div class="alert alert-danger">
        <strong>Error crítico:</strong> Los datos no se cargaron (null)
    </div>
}
else if (topProductos.Any())
{
    <!-- Layout de dos columnas -->
    <div class="row">
        <!-- Columna grafico -->
        <div class="col-lg-8 col-xl-auto mb-4">
            <div class="chart-container">
                <SfChart @ref="chartRef"
                         Width="100%"
                         Height="500px">
                    <ChartTitle Text="Top @topProductos.Count Productos Más Reservados"></ChartTitle>
                    <ChartPrimaryXAxis ValueType="Syncfusion.Blazor.Charts.ValueType.Category" 
                                      Title="Productos"
                                      LabelRotation="45">
                    </ChartPrimaryXAxis>
                    <ChartPrimaryYAxis Title="Cantidad Reservada (unidades)"
                                       Minimum="0"
                                       Interval="50"
                                       LabelFormat="{value}">
                    </ChartPrimaryYAxis>
                    <ChartSeriesCollection>
                        <ChartSeries DataSource="@topProductos" 
                                   XName="NombreProducto" 
                                   YName="CantidadReservada" 
                                   Type="ChartSeriesType.Column" 
                                   Name="Unidades Reservadas"
                                   Query="@(new Syncfusion.Blazor.Data.Query())">
                            <ChartSeriesMarker Visible="true"></ChartSeriesMarker>
                            <ChartSeriesDataLabel Visible="true" Position="Syncfusion.Blazor.Charts.DataLabelPosition.Top">
                            </ChartSeriesDataLabel>
                            <ChartSeriesBorder Width="2" Color="#0d6efd"></ChartSeriesBorder>
                        </ChartSeries>
                    </ChartSeriesCollection>
                    <ChartLegendSettings Visible="true" Position="LegendPosition.Top">
                    </ChartLegendSettings>
                    <ChartTooltipSettings Enable="true"></ChartTooltipSettings>
                </SfChart>
            </div>
        </div>

        <!-- Columna derecha detalles -->
        <div class="col-lg-8 col-xl-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Detalles Completos</h5>
                    <small class="opacity-75">@topProductos.Count productos</small>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover mb-0">
                            <thead class="table-light sticky-top" style="top: 0;">
                                <tr>
                                    <th width="50">#</th>
                                    <th>Producto</th>
                                    <th width="80" class="text-end">Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>
                                @for (int i = 0; i < topProductos.Count; i++)
                                {
                                    var item = topProductos[i];
                                    <tr>
                                        <td>
                                            <span class="badge @GetBadgeClass(i)">@(i + 1)</span>
                                        </td>
                                        <td>
                                            <div class="product-name">
                                                <strong>@item.NombreProducto</strong>
                                                <small class="d-block text-muted">Numero de reserva: @item.NumeroReservas</small>
                                            </div>
                                        </td>
                                        <td class="text-end">
                                            <span class="fw-bold text-primary">@item.CantidadReservada.ToString("N0")</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

   
}
else
{
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Atención:</strong> No hay productos con reservas en el sistema.
    </div>
}

@code {
    private SfChart chartRef;


    private List<TopProductoReservadoDTO> topProductos = new();
    private int cant = 5;
    private bool cargando = false;
    private string errorMessage = "";
    private int totalUnidades = 0;
    private int totalReservas = 0;
    private int maxCantidad = 0;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        cargando = true;
        errorMessage = "";

        // Limpiar datos visualmente primero
        topProductos = new List<TopProductoReservadoDTO>();
        await InvokeAsync(StateHasChanged);
        await Task.Delay(50);

        try
        {
            if (cant < 1) cant = 1;
            if (cant > 50) cant = 50;

            // Cargar nuevos datos
            var nuevosDatos = await ReportesService.GetTopProductosReservadosAsync(cant);

            // Asegurar que es una nueva instancia
            topProductos = nuevosDatos?.ToList() ?? new List<TopProductoReservadoDTO>();

            if (topProductos.Any())
            {
                totalUnidades = topProductos.Sum(p => p.CantidadReservada);
                totalReservas = topProductos.Sum(p => p.NumeroReservas);
                maxCantidad = topProductos.Max(p => p.CantidadReservada);

                // Forzar actualización del gráfico
                await Task.Delay(100);
                await InvokeAsync(StateHasChanged);

                if (chartRef != null)
                {
                    await chartRef.RefreshAsync();
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            cargando = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await CargarDatos();
        }
    }

    private async Task HandleOnClick()
    {
        await CargarDatos();
        StateHasChanged();
    }

    private string GetBadgeClass(int posicion)
    {
        return posicion switch
        {
            0 => "bg-warning text-dark",
            1 => "bg-secondary",
            2 => "bg-info",
            _ => "bg-light text-dark"
        };
    }

    private string GetProgressBarClass(int posicion)
    {
        return posicion switch
        {
            0 => "bg-warning",
            1 => "bg-secondary",
            2 => "bg-info",
            _ => "bg-primary"
        };
    }

    private void Volver()
    {
        Navigation.NavigateTo("/reportes");
    }
}

<style>
    /* Estilos para el layout de dos columnas */
    .chart-container {
        width: 100%;
        padding: 20px;
        background: black
        border-radius: 10px;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    }

    /* Asegurar que el gráfico ocupe todo el espacio */
    .e-chart {
        width: 100% !important;
        height: 100% !important;
        min-height: 450px;
    }

    /* Estilos para la tabla lateral */
    .card {
        width:1200px;
        border: none;
        box-shadow: 0 3px 15px rgba(0,0,0,0.08);
        height: 100%
    }

    .card-header {
        border-radius: 10px 10px 0 0 !important;
        padding: 1rem 1.25rem;
    }

    .table-responsive {
        border-radius: 0 0 10px 10px;
    }

    .table th {
        font-weight: 600;
        font-size: 0.85rem;
        white-space: nowrap;
        border-top: none;
    }

    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }

    .product-name {
        max-width: 180px;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Scroll personalizado para la tabla lateral */
    .table-responsive::-webkit-scrollbar {
        width: 6px;
    }

    .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .table-responsive::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 3px;
    }

    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #a8a8a8;
    }

    /* Estilos para badges */
    .badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
        min-width: 2.2em;
    }

    /* Responsividad */
    @@media (max-width: 992px) {
        .chart-container {
            margin-bottom: 20px;
            height: 400px;
        }
        
        .card {
            height: auto;
        }
    }

    /* Estilos generales */
    .input-group {
        max-width: 250px;
    }

    .progress {
        border-radius: 10px;
        background-color: #e9ecef;
    }

    .progress-bar {
        border-radius: 10px;
        transition: width 0.6s ease;
    }

    .alert {
        border-radius: 10px;
        border: none;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    /* Mejoras para el gráfico */
    .e-series-0 {
        fill: #0d6efd;
        opacity: 0.85;
    }

    .e-series-0:hover {
        opacity: 1;
        fill: #0b5ed7;
    }

    .e-data-label {
        font-weight: 600;
        font-size: 12px;
    }
</style>